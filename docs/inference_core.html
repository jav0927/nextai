---

title: inference_core


keywords: fastai
sidebar: home_sidebar

summary: "Utility methods used in vision training and inference."
description: "Utility methods used in vision training and inference."
nb_path: "00_inference_core.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 00_inference_core.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">IN_COLAB</span> <span class="o">=</span> <span class="s1">&#39;google.colab&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">get_ipython</span><span class="p">())</span>
<span class="k">if</span> <span class="n">IN_COLAB</span><span class="p">:</span>
  <span class="o">!</span>pip install git+https://github.com/pete88b/nbdev_colab_helper.git
  <span class="kn">from</span> <span class="nn">nbdev_colab_helper.core</span> <span class="k">import</span> <span class="o">*</span>
  <span class="n">project_name</span> <span class="o">=</span> <span class="s1">&#39;nextai&#39;</span>
  <span class="n">init_notebook</span><span class="p">(</span><span class="n">project_name</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<blockquote><p>Convert bounding box coordinates from CTRHW to x1, y1, x2, y2 formats.<br>
IMPORTANT:The method expects the input box tensor to be in CxCyHW.</p>
</blockquote>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="ctrhw2tlbr" class="doc_header"><code>ctrhw2tlbr</code><a href="https://github.com/jav0927/nextai_lib/tree/master/nextai_lib/inference_core.py#L17" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>ctrhw2tlbr</code>(<strong><code>boxes</code></strong>:<code>Tensor</code>, <strong><code>set_if_input_is_CxCyWH</code></strong>=<em><code>False</code></em>)</p>
</blockquote>
<p>Convert bounding box coordinates from CTRHW to x1, y1, x2, y2 formats
IMPORTANT: The method expects the input box tensor to be in CxCyHW.
Inputs:
    Boxes        - torch.tensor of activation bounding boxes
    Dim  -         (batch size x Items in batch x 4). It will fail otherwise.
    Input Format - Center coord, height, width</p>
<p>Output:
    torch.tensor of activation bounding boxes
    Dim = (batch size, Items in batch, 4)
    Format: x1, y1, x2, y2</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="tlbr2cthw" class="doc_header"><code>tlbr2cthw</code><a href="https://github.com/jav0927/nextai_lib/tree/master/nextai_lib/inference_core.py#L40" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>tlbr2cthw</code>(<strong><code>boxes</code></strong>:<code>Tensor</code>, <strong><code>ctrhw</code></strong>=<em><code>True</code></em>)</p>
</blockquote>
<p>Convert top/left bottom/right format <code>boxes</code> to center/size corners.
Input:
    boxes - torch.Tensor of activations bounding boxes
            Unbounded
            Dim = (batch size, Items in batch, 4)
            Format: top left xy, bottom right xy
    ctrhw =  True -  Output is in the format CxCyHW
             False - Output is in the format CxCyWH
Output:
            torch.tensor of activation bounding boxes
            Dim = (batch size, Items in the batch, 4)
            Format: center coord xy, height, width</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="activ_decode" class="doc_header"><code>activ_decode</code><a href="https://github.com/jav0927/nextai_lib/tree/master/nextai_lib/inference_core.py#L62" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>activ_decode</code>(<strong><code>p_boxes</code></strong>:<code>Tensor</code>, <strong><code>anchors</code></strong>:<code>Tensor</code>)</p>
</blockquote>
<p>Decodes box activations into final bounding boxes by calculating predicted anchor offsets, which are then added to anchor boxes
Input:
    p_boxes - torcht.tensor of activation bounding boxes
              dim:       (batch, items in batch, 4)
              Format:     top left xy, bottom right xy
    anchors - torch.tensor of anchors
              Dim:       (k * no of classes) x 4
              Format:    CxCyWH format
Output:
              torcht.tensor with anchor boxes offset by box activations
              dim:    batch x tems in batch x 4)
              Format: tlbr - top left xy, bottom right xy</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="activ_encode" class="doc_header"><code>activ_encode</code><a href="https://github.com/jav0927/nextai_lib/tree/master/nextai_lib/inference_core.py#L93" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>activ_encode</code>(<strong><code>p_boxes</code></strong>:<code>Tensor</code>, <strong><code>anchors</code></strong>:<code>Tensor</code>)</p>
</blockquote>
<p>Transforms activations into final bounding boxes by calculating predicted anchor offsets, which are then added to the anchor boxes
Input:
    p_boxes - torcht.tensor of activation bounding boxes
              dim:    (batch, items in batch, 4)
              Format: top left xy, bottom right xy
Output:
              torch.tensor</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="strip_zero_rows" class="doc_header"><code>strip_zero_rows</code><a href="https://github.com/jav0927/nextai_lib/tree/master/nextai_lib/inference_core.py#L116" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>strip_zero_rows</code>(<strong><code>bboxes</code></strong>:<code>Tensor</code>)</p>
</blockquote>
<p>Strip zero-valued rows from a bounding box tensor
Input:  bboxes   Bounding boox tensor
Output: b_out    Tensor with data rows
        z_out    Tensor with zero-filled rows</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="graft_zerorows_to_tensor" class="doc_header"><code>graft_zerorows_to_tensor</code><a href="https://github.com/jav0927/nextai_lib/tree/master/nextai_lib/inference_core.py#L134" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>graft_zerorows_to_tensor</code>(<strong><code>bboxes</code></strong>:<code>Tensor</code>, <strong><code>zboxes</code></strong>:<code>Tensor</code>)</p>
</blockquote>
<p>Graft the all-zero rows back to the bounding box row(s)
Input   bboxes   Bounding boox tensor
        zboxes   Tensor containing the zero-valued rows stripped by strip_zero_rows function
Output  Tensor with data and zero-filled rows of shape[0] = shape bboxes[0} shape.zeroboxes[0]</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">res</span> <span class="o">=</span> <span class="n">graft_zerorows_to_tensor</span><span class="p">(</span><span class="n">strip</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">strip</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span><span class="n">res</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>tensor([[[1, 2, 3, 4],
         [1, 2, 3, 4],
         [0, 0, 0, 0],
         [0, 0, 0, 0]],

        [[1, 2, 3, 4],
         [1, 2, 3, 4],
         [0, 0, 0, 0],
         [0, 0, 0, 0]]])</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="flip_on_y_axis" class="doc_header"><code>flip_on_y_axis</code><a href="https://github.com/jav0927/nextai_lib/tree/master/nextai_lib/inference_core.py#L144" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>flip_on_y_axis</code>(<strong><code>bboxes</code></strong>:<code>Tensor</code>)</p>
</blockquote>
<p>Flip a bounding box along the y axis
Input:   bboxes   Bounding box tensor</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="flip_on_x_axis" class="doc_header"><code>flip_on_x_axis</code><a href="https://github.com/jav0927/nextai_lib/tree/master/nextai_lib/inference_core.py#L151" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>flip_on_x_axis</code>(<strong><code>bboxes</code></strong>:<code>Tensor</code>)</p>
</blockquote>
<p>Flip a bounding box along the x axis
Input:   bboxes   Bounding boox tensor</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="rotate_90_plus" class="doc_header"><code>rotate_90_plus</code><a href="https://github.com/jav0927/nextai_lib/tree/master/nextai_lib/inference_core.py#L157" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>rotate_90_plus</code>(<strong><code>bb</code></strong>:<code>Tensor</code>)</p>
</blockquote>
<p>Rotate bounding box(s) by 90 degrees clockwise
Input:   bboxes   Bounding boox tensor</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="rotate_90_minus" class="doc_header"><code>rotate_90_minus</code><a href="https://github.com/jav0927/nextai_lib/tree/master/nextai_lib/inference_core.py#L163" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>rotate_90_minus</code>(<strong><code>bb</code></strong>:<code>Tensor</code>)</p>
</blockquote>
<p>Rotate bounding box(s) by 90 degrees counterclockwise
Input:   bboxes   Bounding boox tensor in xyxy format</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Function is insensitive to tensor dimensions</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">nbdev.cli</span> <span class="k">import</span> <span class="n">nbdev_build_docs</span>
<span class="n">nbdev_build_docs</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

</div>

</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>converting: /content/drive/My Drive/Colab Notebooks/github/nextai/00_inference_core.ipynb
converting: /content/drive/My Drive/Colab Notebooks/github/nextai/00_core.ipynb
converting /content/drive/My Drive/Colab Notebooks/github/nextai/index.ipynb to README.md
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

